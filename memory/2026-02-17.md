# 2026-02-17 — Chatbot Unified Cron Migration

## What Happened
- Migrated Bianca chatbot from dispatcher+sub-agents to **unified cron** architecture
- One Opus session handles up to 5 fans per turn, fires every 45s
- Cron ID: `c9c8339c-0633-4ee5-b26c-a225e8dd7b13`
- Cuts Claude API calls by 60-70% vs old approach
- Successfully processing fans: Tyler, Josechibarra ($24+$15 PPVs purchased), Michto974, danish1245, Vaxden

## Architecture
- **Old:** dispatcher cron → N sub-agents (parallel rate limit hell)
- **New:** single cron → one Opus session reads brain v3 + agent prompt, handles all fans
- Railway relay endpoints exist as fallback but unified cron calls OF API directly
- Dedup via `research/bianca-dispatch-lock.json`

## Issues
- **401 auth error** on last cron run (ts 1771369430425) — OF API token may need refresh
- Intermittent Opus rate limiting still occurring
- Need to check if OF API key `ofapi_bT4J1Er2YBow46EihDfjlSFf5HRmiM15M4DCOoHn7889d8b4` expired

## Other Active Crons
- `bianca-bump` (hourly, id `417c8122`) — also consumes Opus
- `bianca-new-sub-welcome` (5min, id `079f250e`) — also consumes Opus

## Key Files
- `research/bianca-agent-prompt.md` — vault IDs, content catalog
- `research/chatbot-brain-v3.md` — 33KB sales playbook
- `research/bianca-fan-state.json` — per-fan state
- `s4s-rotation-service/chatbot-engine.js` — relay mode code (Railway)

## Duplicate PPV Fix
- Added conversation history marking for sent PPVs with "DO NOT re-pitch"
- Added CRITICAL rule to system prompt
